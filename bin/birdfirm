#!/bin/bash

birdfirm_main(){
  local root
  local bin
  local list
  local executable
  local path

  root=$HOME/.birdfirm
  bin=$root/bin
  list=$bin.txt

  if [ ! -d "$bin" ]; then
    echo "birdfirm bin not found : $bin"
    return
  fi

  while [ true ]; do
    birdfirm_build_hosts

    executable=$(cat $list | fzf)
    executable=${executable##* }
    if [ -z "$executable" ]; then
      return
    else
      path=$bin/$executable
      if [ -f "$path" ]; then
        $path
      fi
    fi
  done
}

birdfirm_build_hosts(){
  ls -1 $bin | awk '{print "  " $1}' > $list
  if [ "$(which tmux 2> /dev/null)" ]; then
    birdfirm_build_hosts_tmux
  fi
}
birdfirm_build_hosts_tmux(){
  local socket
  local session
  for socket in $HOME/.tmux.wrapper/tmux-*.sock; do
    for session in $(tmux -S $socket ls -F '#S' 2> /dev/null); do
      sed "s/^  $session$/* $session/" -i $list
    done
  done
}

birdfirm_main
